/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{cyclicalPI as t}from"../../../../../core/Cyclical.js";import e from"../../../../../core/Evented.js";import a from"../../../../../core/Handles.js";import{clamp as i,rad2deg as o}from"../../../../../core/mathUtils.js";import{isSome as s,destroyMaybe as r,unwrapOr as n}from"../../../../../core/maybe.js";import{createAngle as l,createLength as c}from"../../../../../core/quantityUtils.js";import{when as h,initial as p,watch as u}from"../../../../../core/reactiveUtils.js";import{addFrameTask as d}from"../../../../../core/scheduling.js";import{createScreenPointArray as g}from"../../../../../core/screenUtils.js";import{d as m,u as _,m as f,h as M,e as D}from"../../../../../chunks/mat4.js";import{c as S}from"../../../../../chunks/mat4f64.js";import{s as v,b as y,l as b,d as T,f as R,a as j}from"../../../../../chunks/vec3.js";import{a as k,f as w}from"../../../../../chunks/vec3f64.js";import{b as O}from"../../../../../chunks/vec4f64.js";import{fromPositionAndNormal as A,create as I,normal as P}from"../../../../../geometry/support/plane.js";import{wrap as E,distance2 as F}from"../../../../../geometry/support/ray.js";import{sv3d as C,sm4d as U}from"../../../../../geometry/support/vectorStacks.js";import{getGraphicEffectiveElevationInfo as x}from"../../../../../support/elevationInfoUtils.js";import{Manipulator3D as z}from"../../Manipulator3D.js";import{calculateInputRotationTransform as L}from"../../manipulatorUtils.js";import{screenToRenderPlane as N}from"../dragEventPipeline3D.js";import{ManipulatorType as G}from"../ManipulatorType.js";import{ROTATE_INDICATOR_DIRECTION_BUFFER as H,SCALE_INDICATOR_DIRECTION_BUFFER as V,RING_HEIGHT as q,ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE as B,ROTATE_INDICATOR_ARROW_TIP_LENGTH as J,ROTATE_INDICATOR_ARROW_TIP_RADIUS as K,RING_THICKNESS as Q,HANDLE_COLOR as W,DRAG_THRESHOLD_PX as X,RING_INDICATOR_DELAY_MS as Y,RING_RADIUS as Z,INNER_INDICATOR_RADIUS as $,INDICATOR_THICKNESS as tt,OUTER_INDICATOR_RADIUS as et,SCALE_INDICATOR_OFFSET1 as at,SCALE_INDICATOR_OFFSET2 as it,RING_RESET_ANIMATION_SPEED_FACTOR as ot,GEOMETRY_SEGMENTS as st,ROTATE_INDICATOR_ARC_LENGTH as rt,SCALE_INDICATOR_ARC_LENGTH as nt}from"../manipulations/config.js";import{CullFaceOptions as lt}from"../../../webgl-engine/lib/basicInterfaces.js";import ct from"../../../webgl-engine/lib/GeometryUtil.js";import{RenderOccludedFlag as ht}from"../../../webgl-engine/lib/Material.js";import{ColorMaterial as pt}from"../../../webgl-engine/materials/ColorMaterial.js";import{createManipulatorDragEventPipeline as ut}from"../../../../interactive/dragEventPipeline.js";import{ManipulatorStateCustomFlags as dt,ManipulatorStateFlags as gt}from"../../../../interactive/interfaces.js";import{Tooltip as mt}from"../../../../interactive/tooltip/Tooltip.js";import{TransformRotateTooltipInfo as _t,TransformScaleTooltipInfo as ft,TransformAbsoluteTooltipInfo as Mt}from"../../../../interactive/tooltip/TransformTooltipInfos.js";var Dt,St;!function(t){t.ScaleIn=dt.Custom2,t.ScaleOut=dt.Custom3,t.RotateLeft=dt.Custom4,t.RotateRight=dt.Custom5,t.Unlocked=dt.Custom7,t.DelayedFocused=dt.Custom8,t.TouchInput=dt.Custom12}(Dt||(Dt={}));class vt{constructor({adapter:t,tooltipOptions:i,mode:o,tool:r}){this.mode=null,this._handles=new a,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new e,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>s(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this.adapter.scale:1,this.tool=r,this.mode=o,this.adapter=t,this._tooltipOptions=i,this._tooltip=new mt({view:r.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(h((()=>!this._tooltipOptions.enabled),(()=>this._tooltip.clear()),p))}get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}destroy(){s(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=r(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=r(this._tooltip)}startAnimation(t){this.cancelActiveAnimation(),t.start();const e=d({update:({deltaTime:e})=>{t.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:e}}cancelActiveAnimation(){s(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=r(this._activeAnimation))}forEachManipulator(t){t(this._ringManipulator,G.SCALE_ROTATE)}_createManipulator(){const e=this._createRingManipulator();this._ringManipulator=e,this.tool.manipulators.add(e);const a=this.tool.graphicState.graphic,r=ut(e,((e,r,n)=>{this._scaleRotateDragData=null;const l=this.adapter.startInteraction(),c={mode:"none",origin:k(e.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=c,this._updateDragState();const h=C.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(e.renderLocation,h),r.next(N(this.tool.view,A(e.renderLocation,h,I()))).next((e=>{const r=P(e.plane),n=L(e.renderStart,e.renderEnd,c.origin,r),h=t.shortestSignedDiff(c.angle,n);c.angleDir=i(c.angleDir+h,-H,H),c.angle=n;const p=yt(c,e),u=p-this.adapter.scale;if(c.scaleDir=i(c.scaleDir+u,-V,V),this._onScaleChanged(),"none"===c.mode){const t=this.mode||bt(e,e.plane,c.origin,this.tool.view.state.camera);if(s(t)){switch(t){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:a,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:a,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}c.mode=t}}switch(c.mode){case"rotate":l.state.angle=c.initialAngle+n;break;case"scale":l.state.scale=p,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),e.action){case"start":case"update":switch(c.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:a,angle:o(c.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:a,xScale:p,yScale:p})}break;case"end":switch(c.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:a,angle:o(c.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:a,xScale:p,yScale:p})}}return"end"===e.action&&(this.startAnimation(Rt(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState(),l.done()),e})).next(this._updateTooltipPipelineStep(c)),n.next((()=>{if(l.cancel(),s(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:a,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:a,xScale:1,yScale:1})}this.startAnimation(Rt(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()}))}));this._handles.add([r,e.events.on("focus-changed",(t=>{"focus"===t.action?this.startAnimation(jt(this,(()=>this._updateDelayedFocusedState()))):this._updateDelayedFocusedState()})),e.events.on("immediate-click",(t=>{t.stopPropagation()})),u((()=>this.tool.graphicState?.displaying),(t=>this._ringManipulator.available=t),p)])}_updateTooltipPipelineStep(t){return e=>{const a=this._tooltipOptions;if(!a.enabled)return e;if("end"===e.action)return this._updateFocusTooltip(),e;const i=this._tooltip,o=this._tooltipOptions.visualVariables,r=s(o)?o.size:null,h=s(o)?o.rotation:null;switch(t.mode){case"scale":i.info=new ft({tooltipOptions:a,scale:{value:this.adapter.scale},size:c(n(this.adapter.size,-1),"meters"),sizeUnit:s(r)?r.unit:null,sizePrecision:s(r)?kt(r.valueType):null});break;case"rotate":{const t=s(h)?kt(h.valueType):null,e=s(h)?h.rotationType:"geographic";i.info=new _t({tooltipOptions:a,rotation:l(n(-this.adapter.relativeAngle,0),"radians","geographic"),rotationPrecision:t,orientation:l(-this.adapter.angle,"radians","geographic"),orientationPrecision:t,rotationType:e})}}return e}}_updateFocusTooltip(){if(!this._tooltipOptions.enabled)return;if(this.getFocused()){const t=this._tooltipOptions.visualVariables,e=s(t)?t.rotation:null,a=s(t)?t.size:null;this._tooltip.info=new Mt({tooltipOptions:this._tooltipOptions,orientation:l(-this.adapter.angle,"radians","geographic"),orientationEnabled:null==this.mode||"rotate"===this.mode,orientationPrecision:s(e)?kt(e.valueType):null,rotationType:s(e)?e.rotationType:"geographic",size:c(n(this.adapter.size,-1),"meters"),sizeUnit:s(a)?a.unit:null,sizeEnabled:null==this.mode||"scale"===this.mode,sizePrecision:s(a)?kt(a.valueType):null})}else this._tooltip.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(Dt.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(Dt.Unlocked,!(s(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),s(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(Dt.ScaleIn|Dt.ScaleOut,!1),this._ringManipulator.updateStateEnabled(Dt.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(Dt.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(Dt.RotateLeft|Dt.RotateRight,!1),this._ringManipulator.updateStateEnabled(Dt.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(Dt.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(Dt.ScaleIn|Dt.ScaleOut|Dt.RotateLeft|Dt.RotateRight,!1)}_updateManipulatorTransform(){const t=m(U.get(),this.adapter.angle,w(0,0,1)),e=this.getScale(),a=_(U.get(),v(C.get(),e,e,e));this._ringManipulator.modelTransform=f(U.get(),a,t)}_createRingManipulator(){const t=(t,e,a)=>{const i=[],o=Math.ceil(st*(e-t)/(2*Math.PI));for(let s=0;s<o+1;s++){const r=t+s*(e-t)/o;i.push(w(a*Math.cos(r),a*Math.sin(r),0))}return i},e=e=>t(0,2*Math.PI,e),a=t=>[[-t/2,0],[t/2,0],[t/2,q/2],[-t/2,q/2]],i=(t,e)=>ct.createPathExtrusionGeometry(a(e),t,[],[],!1),o=e(Z),s=i(o,Q),r={left:[],right:[]},n=[];for(let j=0;j<2;j++){const e=j*Math.PI-Math.PI/4,a=Math.PI/2-rt,o=e+a,s=e+Math.PI/2-a,l=t(o,s,$),c=i(l,tt);n.push(l),n.push(t(o,s,et-Q/2)),r.left.push(c),r.right.push(c);for(let t=0;t<2;t++){const e=0===t,a=S();if(e){M(a,a,[1,-1,1]),D(a,a,-o,[0,0,1]);const t=Math.round(B*(l.length-1));a[12]=l[t][0],a[13]=l[t][1],a[14]=l[t][2]}else{D(a,a,s,[0,0,1]);const t=Math.round((1-B)*(l.length-1));a[12]=l[t][0],a[13]=l[t][1],a[14]=l[t][2]}const i=ct.createExtrudedTriangle(J,0,K,q);ct.transformInPlace(i,a),(e?r.left:r.right).push(i)}}const l=[];for(let M=0;M<2;M++){const e=M*Math.PI-Math.PI/4,a=Math.PI/2-nt,o=e+a,s=e+Math.PI/2-a,r=t(o,s,et);l.push(i(r,tt))}const c=e(Z+at),h=e(Z+it),p=i(c,tt),u=i(h,tt),d=e(Z-at),g=e(Z-it),m=i(d,tt),_=i(g,tt),f=this._createMaterial(),v=this._createMaterial(.66),y=this._createMaterial(.5),b=this._createMaterial(.33);let T=[{geometry:s,material:f,stateMask:Dt.DelayedFocused},{geometry:s,material:y,stateMask:gt.None}];this.mode&&"scale"!==this.mode||(T=T.concat([{geometry:l,material:f,stateMask:Dt.DelayedFocused|Dt.Unlocked},{geometry:p,material:v,stateMask:Dt.DelayedFocused|Dt.ScaleIn},{geometry:u,material:b,stateMask:Dt.DelayedFocused|Dt.ScaleIn},{geometry:m,material:v,stateMask:Dt.DelayedFocused|Dt.ScaleOut},{geometry:_,material:b,stateMask:Dt.DelayedFocused|Dt.ScaleOut}])),this.mode&&"rotate"!==this.mode||(T=T.concat([{geometry:r.right,material:f,stateMask:Dt.DelayedFocused|Dt.Unlocked},{geometry:r.left,material:f,stateMask:Dt.DelayedFocused|Dt.RotateLeft},{geometry:r.right,material:f,stateMask:Dt.DelayedFocused|Dt.RotateRight}]));const R=[o,...n];return new z({view:this.tool.view,renderObjects:T,autoScaleRenderObjects:!1,worldOriented:!0,radius:Q,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:x(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:R,direction:w(0,0,1)}})}_createMaterial(t=1){const e=O([...W,t]);return new pt({color:e,transparent:1!==t,cullFace:lt.Back,renderOccluded:ht.Transparent})}get test(){return{ringManipulator:this._ringManipulator,tooltip:this._tooltip}}}function yt(t,e){const a=y(C.get(),e.renderStart,t.origin),i=y(C.get(),e.renderEnd,t.origin),o=b(a),s=b(i);return 0===o?0:s/o}function bt(t,e,a,i){const{renderStart:o,renderEnd:s}=t,r=Tt(o,i,C.get()),n=Tt(s,i,C.get());if(T(r,n)<X*X)return null;const l=y(C.get(),o,a),c=R(C.get(),l,P(e)),h=o,p=j(C.get(),h,c),u=Tt(a,i,C.get()),d=r,g=Tt(p,i,C.get()),m=y(C.get(),g,d),_=y(C.get(),r,u),f=E(d,m),M=E(u,_);return F(f,n)<F(M,n)?"rotate":"scale"}function Tt(t,e,a){return e.projectToScreen(t,wt),v(a,wt[0],wt[1],0)}function Rt(t,e){let a=null,i=1;const o=()=>i;return{start:()=>{i=t.getScale(),a=t.getScale,t.getScale=o,e()},update:t=>(i+=((i+1)/2-i)*Math.min(t*ot,1),e(),Math.abs(i-1)<.01?St.STOP:St.CONTINUE),destroy:()=>{t.getScale=a,e()}}}function jt(t,e){let a=0,i=null;const o=()=>!1;return{start:()=>{i=t.getFocused,t.getFocused=o,a=0,e()},update:t=>(a+=t,!i()||a>Y?St.STOP:St.CONTINUE),destroy:()=>{t.getFocused=i,e()}}}function kt(t){switch(t){case"integer":case"long":return 0;default:return null}}!function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"}(St||(St={}));const wt=g();export{vt as GraphicScaleRotateTransform};
