{
  "version": 3,
  "sources": ["../../@arcgis/core/layers/support/rasterDatasets/EphemeralBlockCache.js", "../../@arcgis/core/layers/support/rasterDatasets/RawBlockCache.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.24/esri/copyright.txt for details.\n*/\nclass t{constructor(t=15e3,e=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,e)}decreaseRefCount(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.refCount--,t.refCount<=0&&(r.delete(s),t.controller&&t.controller.abort()),t.refCount}return 0}getBlock(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.ts=Date.now(),t.refCount++,r.delete(s),r.set(s,t),t.block}return null}putBlock(t,e,s,r=null){const i=this._cachedBlocks,c=t+\"/\"+e;if(i.has(c)){const t=i.get(c);t.ts=Date.now(),t.refCount++}else i.set(c,{block:s,ts:Date.now(),refCount:1,controller:r});this._trim(),this._updateTimer()}deleteBlock(t,e){const s=this._cachedBlocks,r=t+\"/\"+e;s.has(r)&&s.delete(r)}updateMaxSize(t){this._size=t,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const t=this._cachedBlocks;this._timer=setInterval((()=>{const e=Array.from(t),s=Date.now();for(let r=0;r<e.length&&e[r][1].ts<=s-this._duration;r++)t.delete(e[r][0]);0===t.size&&this._clearTimer()}),this._interval)}_trim(){const t=this._cachedBlocks;if(-1===this._size||this._size>=t.size)return;const e=Array.from(t);for(let s=0;s<e.length-this._size;s++)t.delete(e[s][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}export{t as default};\n", "/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.24/esri/copyright.txt for details.\n*/\nimport\"../../../geometry.js\";import{isSome as e}from\"../../../core/maybe.js\";import t from\"./EphemeralBlockCache.js\";import{projectExtent as n,projectResolution as o,snapPyramid as r}from\"../rasterFunctions/rasterProjectionHelper.js\";import l from\"../../../geometry/Point.js\";const c=new Map,a=new t;function i(e,t){return null==t?e:`${e}?sliceId=${t}`}function s(e,t){const n={extent:null,rasterInfo:t,cache:new Map};if(c.has(e)){const t=c.get(e);return t.push(n),t.length-1}return c.set(e,[n]),0}function u(e,t){if(c.has(e)){const n=c.get(e);n[t]=null,n.some((e=>null!=e))||c.delete(e)}}function f(e){c.delete(e)}function h(e,t,n){if(!c.has(e))return null==t?a.decreaseRefCount(e,n):0;const o=c.get(e);if(null==o[t])return a.decreaseRefCount(e,n);const r=o[t].cache;if(r.has(n)){const e=r.get(n);if(e.refCount--,0===e.refCount){r.delete(n);for(let e=0;e<o.length;e++)o[e]&&o[e].cache.has(n)&&o[e].cache.delete(n);e.controller&&e.controller.abort()}return e.refCount}return 0}function m(e,t,n){if(!c.has(e))return null==t?a.getBlock(e,n):null;const o=c.get(e);if(null==o[t]){for(let e=0;e<o.length;e++)if(o[e]&&o[e].cache.has(n)){const t=o[e].cache.get(n);return t.refCount++,t.block}return a.getBlock(e,n)}const r=o[t].cache;if(r.has(n)){const e=r.get(n);return e.refCount++,e.block}for(let l=0;l<o.length;l++)if(l!==t&&o[l]&&o[l]&&o[l].cache.has(n)){const e=o[l].cache.get(n);return e.refCount++,r.set(n,e),e.block}return null}function x(e,t,n,o,r=null){if(!c.has(e))return void(null==t&&a.putBlock(e,n,o,r));const l=c.get(e);if(null==l[t])return void a.putBlock(e,n,o,r);const i={refCount:1,block:o,isResolved:!1,isRejected:!1,controller:r};o.then((()=>i.isResolved=!0)).catch((()=>i.isRejected=!0)),l[t].cache.set(n,i)}function d(e,t,n){if(!c.has(e))return void(null==t&&a.deleteBlock(e,n));const o=c.get(e);null!=o[t]?o[t].cache.delete(n):a.deleteBlock(e,n)}function y(e,t){if(!c.has(e))return null;const n=c.get(e);return null==n[t]?null:n[t]}function g(t,c,a,i,s,u,f=null){const h=y(t,c),m=h.extent,{cache:x,rasterInfo:d}=h;if(m&&m.xmin===a.xmin&&m.xmax===a.xmax&&m.ymin===a.ymin&&m.ymax===a.ymax)return;const g=a.clone().normalize(),{spatialReference:p,transform:k}=d,M=new Set;for(let y=0;y<g.length;y++){const t=g[y];if(t.xmax-t.xmin<=i||t.ymax-t.ymin<=i)continue;let c=n(t,p,f);e(k)&&(c=k.inverseTransform(c));const a=new l({x:i,y:i,spatialReference:t.spatialReference});if(null==s&&!(s=o(a,p,t,f)))return;const{pyramidLevel:h,pyramidResolution:m,excessiveReading:x}=r(s,d,u||\"closest\");if(x)return;const{storageInfo:R}=d,{origin:C}=R,j={x:Math.max(0,Math.floor((c.xmin-C.x)/m.x)),y:Math.max(0,Math.floor((C.y-c.ymax)/m.y))},v=Math.ceil((c.xmax-c.xmin)/m.x-.1),B=Math.ceil((c.ymax-c.ymin)/m.y-.1),b=h>0?R.pyramidBlockWidth:R.blockWidth,w=h>0?R.pyramidBlockHeight:R.blockHeight,$=1,I=Math.max(0,Math.floor(j.x/b)-$),H=Math.max(0,Math.floor(j.y/w)-$),E=Math.floor((j.x+v-1)/b)+$,P=Math.floor((j.y+B-1)/w)+$;for(let e=H;e<=P;e++)for(let t=I;t<=E;t++)M.add(`${h}/${e}/${t}`)}x.forEach(((e,t)=>{if(!M.has(t)){const e=x.get(t);(null==e||e.isResolved||e.isRejected)&&x.delete(t)}})),h.extent={xmin:a.xmin,ymin:a.ymin,xmax:a.xmax,ymax:a.ymax}}export{h as decreaseRefCount,d as deleteBlock,f as deleteRaster,m as getBlock,i as getRasterId,x as putBlock,s as register,u as unregister,g as update};\n"],
  "mappings": "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",
  "names": ["t", "s", "r", "i", "c", "t", "e", "t", "r", "e", "i", "c", "a", "s", "u", "h", "m", "x", "d", "g", "y", "j", "v"]
}
