{
  "version": 3,
  "sources": ["../../@arcgis/core/renderers/support/DictionaryLoader.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.24/esri/copyright.txt for details.\n*/\nimport e from\"../../Color.js\";import t from\"../../request.js\";import s from\"../../core/Error.js\";import o from\"../../core/Logger.js\";import i from\"../../core/LRUCache.js\";import{isSome as r}from\"../../core/maybe.js\";import{isAbortError as n}from\"../../core/promiseUtils.js\";import{numericHash as l}from\"../../core/string.js\";import{loadArcade as a,createDictionaryExpression as c}from\"../../support/arcadeOnDemand.js\";import m from\"../../symbols/CIMSymbol.js\";const f=o.getLogger(\"esri.renderers.support.DictionaryLoader\"),h={type:\"CIMSimpleLineCallout\",lineSymbol:{type:\"CIMLineSymbol\",symbolLayers:[{type:\"CIMSolidStroke\",width:.5,color:[0,0,0,255]}]}};class y{constructor(e,t,s){this.config=null,this.fieldMap=null,this.url=null,this._ongoingRequests=new Map,this._symbolCache=new i(100),this.url=e,this.config=t,this.fieldMap=s}getSymbolFields(){return this._symbolFields}async getSymbolAsync(t,s){let o;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(s));try{o=await this._dictionaryPromise}catch(d){if(n(d))return this._dictionaryPromise=null,null}const i={};if(this.fieldMap)for(const e of this._symbolFields){const s=this.fieldMap[e];if(s&&null!=t.attributes[s]){const o=\"\"+t.attributes[s];i[e]=o}else i[e]=\"\"}const a=o(i,s);if(!a||\"string\"!=typeof a)return null;const c=l(a).toString(),m=this._symbolCache.get(c);if(m)return m.catch((()=>{this._symbolCache.pop(c)})),m;const f=a.split(\";\"),h=[],y=[];for(const r of f)if(r)if(r.includes(\"po:\")){const t=r.substr(3).split(\"|\");if(3===t.length){const s=t[0],o=t[1];let i=t[2];if(\"DashTemplate\"===o)i=i.split(\" \").map((e=>Number(e)));else if(\"Color\"===o){const t=new e(i).toRgba();i=[t[0],t[1],t[2],255*t[3]]}else i=Number(i);y.push({primitiveName:s,propertyName:o,value:i})}}else if(r.includes(\"|\")){for(const e of r.split(\"|\"))if(this._itemNames.has(e)){h.push(e);break}}else this._itemNames.has(r)&&h.push(r);const u=!r(t.geometry)||!t.geometry.hasZ&&\"point\"===t.geometry.type,p=this._cimPartsToCIMSymbol(h,y,u,s);return this._symbolCache.put(c,p,1),p}async fetchResources(e){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void f.error(\"no valid URL!\");const o=t(this.url+\"/resources/styles/dictionary-info.json\",{responseType:\"json\",query:{f:\"json\"},signal:r(e)?e.signal:null}),[{data:i}]=await Promise.all([o,a()]);if(!i)throw this._dictionaryPromise=null,new s(\"esri.renderers.DictionaryRenderer\",\"Bad dictionary data!\");const n=i.expression,l=i.authoringInfo;this._refSymbolUrlTemplate=this.url+\"/\"+i.cimRefTemplateUrl,this._itemNames=new Set(i.itemsNames),this._symbolFields=l.symbol;const m={};if(this.config){const e=this.config;for(const t in e)m[t]=e[t]}if(l.configuration)for(const t of l.configuration)m.hasOwnProperty(t.name)||(m[t.name]=t.value);const h=[];if(r(e)&&e.fields&&this.fieldMap)for(const t of this._symbolFields){const s=this.fieldMap[t],o=e.fields.filter((e=>e.name===s));o.length>0&&h.push({...o[0],name:t})}return this._dictionaryPromise=c(n,r(e)?e.spatialReference:null,h,m).then((e=>{const t={scale:0};return(s,o)=>{const i=e.repurposeFeature({geometry:null,attributes:s});return t.scale=r(o)?o.scale:void 0,e.evaluate({$feature:i,$view:t})}})).catch((e=>(f.error(\"Creating dictinoary expression failed:\",e),null))),this._dictionaryPromise}async _cimPartsToCIMSymbol(e,t,s,o){const i=new Array(e.length);for(let l=0;l<e.length;l++)i[l]=this._getSymbolPart(e[l],o);const r=await Promise.all(i),n=this.fieldMap;for(const l of r)u(l,n);return new m({data:this._combineSymbolParts(r,t,s)})}async _getSymbolPart(e,s){if(this._ongoingRequests.has(e))return this._ongoingRequests.get(e).then((e=>e.data));const o=this._refSymbolUrlTemplate.replace(/\\{itemName\\}/gi,e),i=t(o,{responseType:\"json\",query:{f:\"json\"},...s});this._ongoingRequests.set(e,i);try{return(await i).data}catch(r){throw this._ongoingRequests.delete(e),r}}_combineSymbolParts(e,t,s){if(!e||0===e.length)return null;const o={...e[0]};if(e.length>1){o.symbolLayers=[];for(const t of e){const e=t;o.symbolLayers.unshift(...e.symbolLayers)}}return s&&(o.callout=h),{type:\"CIMSymbolReference\",symbol:o,primitiveOverrides:t}}}function u(e,t){if(!e)return;const s=e.symbolLayers;if(!s)return;let o=s.length;for(;o--;){const e=s[o];if(e&&!1!==e.enable&&\"CIMVectorMarker\"===e.type)p(e,t)}}function p(e,t){const s=e.markerGraphics;if(s)for(const o of s){if(!o)continue;const e=o.symbol;if(e)switch(e.type){case\"CIMPointSymbol\":case\"CIMLineSymbol\":case\"CIMPolygonSymbol\":u(e,t);break;case\"CIMTextSymbol\":e.fieldMap=t}}}export{y as DictionaryLoader};\n"],
  "mappings": "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",
  "names": ["e", "s", "d", "o", "a", "c", "f", "h", "y", "r", "t", "i", "u", "p", "n", "l"]
}
