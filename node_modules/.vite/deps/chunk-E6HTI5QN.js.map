{
  "version": 3,
  "sources": ["../../@arcgis/core/layers/support/FetchAssociatedFeatureLayer.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.24/esri/copyright.txt for details.\n*/\nimport{id as t}from\"../../kernel.js\";import r from\"../../request.js\";import{isNone as e,isSome as a}from\"../../core/maybe.js\";import{throwIfAbortError as s}from\"../../core/promiseUtils.js\";import i from\"../FeatureLayer.js\";import o from\"../../portal/Portal.js\";import n from\"../../portal/PortalItem.js\";class l{constructor(t,r,e,a){this.parsedUrl=t,this.portalItem=r,this.apiKey=e,this.signal=a,this.rootDocument=null;const s=this.parsedUrl.path.match(/^(.*)\\/SceneServer\\/layers\\/([\\d]*)\\/?$/i);s&&(this.urlParts={root:s[1],layerId:parseInt(s[2],10)})}async fetch(){if(!this.urlParts)return null;const t=this.portalItem??await this._portalItemFromServiceItemId();if(e(t))return this._loadFromUrl();const r=await this._findAndLoadRelatedPortalItem(t);return e(r)?null:this._loadFeatureLayerFromPortalItem(r)}async fetchPortalItem(){if(!this.urlParts)return null;const t=this.portalItem??await this._portalItemFromServiceItemId();return e(t)?null:this._findAndLoadRelatedPortalItem(t)}async _fetchRootDocument(){if(a(this.rootDocument))return this.rootDocument;if(e(this.urlParts))return this.rootDocument={},{};const t={query:{f:\"json\",token:this.apiKey},responseType:\"json\",signal:this.signal},s=`${this.urlParts.root}/SceneServer`;try{const e=await r(s,t);this.rootDocument=e.data}catch{this.rootDocument={}}return this.rootDocument}async _fetchServiceOwningPortalUrl(){const e=t?.findServerInfo(this.parsedUrl.path);if(e?.owningSystemUrl)return e.owningSystemUrl;const a=this.parsedUrl.path.replace(/(.*\\/rest)\\/.*/i,\"$1\")+\"/info\";try{const t=(await r(a,{query:{f:\"json\"},responseType:\"json\",signal:this.signal})).data.owningSystemUrl;if(t)return t}catch(i){s(i)}return null}async _findAndLoadRelatedPortalItem(t){try{return(await t.fetchRelatedItems({relationshipType:\"Service2Service\",direction:\"reverse\"},{signal:this.signal})).find((t=>\"Feature Service\"===t.type))||null}catch(r){return s(r),null}}async _loadFeatureLayerFromPortalItem(t){await t.load({signal:this.signal});const r=await this._findMatchingAssociatedSublayerUrl(t.url);return new i({url:r,portalItem:t}).load({signal:this.signal})}async _loadFromUrl(){const t=await this._findMatchingAssociatedSublayerUrl(`${this.urlParts.root}/FeatureServer`);return new i({url:t}).load({signal:this.signal})}async _findMatchingAssociatedSublayerUrl(t){const e=t.replace(/^(.*FeatureServer)(\\/[\\d]*\\/?)?$/i,\"$1\"),a={query:{f:\"json\"},responseType:\"json\",authMode:\"no-prompt\",signal:this.signal},s=this.urlParts.layerId,i=this._fetchRootDocument(),o=r(e,a),[n,l]=await Promise.all([o,i]),c=l&&l.layers,h=n.data&&n.data.layers;if(!Array.isArray(h))throw new Error(\"expected layers array\");if(Array.isArray(c))for(let r=0;r<Math.min(c.length,h.length);r++){if(c[r].id===s)return`${e}/${h[r].id}`}else if(s<h.length)return`${e}/${h[s].id}`;throw new Error(\"could not find matching associated sublayer\")}async _portalItemFromServiceItemId(){const t=(await this._fetchRootDocument()).serviceItemId;if(!t)return null;const r=new n({id:t,apiKey:this.apiKey}),e=await this._fetchServiceOwningPortalUrl();a(e)&&(r.portal=new o({url:e}));try{return r.load({signal:this.signal})}catch(i){return s(i),null}}}export{l as FetchAssociatedFeatureLayer};\n"],
  "mappings": "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",
  "names": ["t", "r", "n", "l"]
}
